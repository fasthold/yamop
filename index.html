<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Yamop : Yet another MongoDB ODM for PHP" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Yamop</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mawelous/yamop">View on GitHub</a>

          <h1 id="project_title">Yamop</h1>
          <h2 id="project_tagline">Yet another MongoDB ODM for PHP</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mawelous/yamop/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mawelous/yamop/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <ul>
<li><a href="#whatsthat">What's that?</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#installation">Installation</a></li>
<li>
<a href="#usage">Usage</a>

<ul>
<li><a href="#getting">getting</a></li>
<li><a href="#save">save, update, delete</a></li>
<li><a href="#embedded">embedded objects</a></li>
<li><a href="#related">relations</a></li>
<li><a href="#output">output format</a></li>
<li><a href="#pagination">pagination</a></li>
<li><a href="#timestamps">timestamps</a></li>
<li><a href="#datetime">dates and time</a></li>
<li><a href="#transactions">transactions</a></li>
</ul>
</li>
<li><a href="#Issues">Issues</a></li>
<li><a href="#license">License</a></li>
</ul><p><a name="whatsthat"></a></p>

<h2>
<a name="whats-that" class="anchor" href="#whats-that"><span class="octicon octicon-link"></span></a>What's that?</h2>

<p>This is yet another, open source, and very simple ODM for <a href="http://www.mongodb.org/">MongoDB</a>.
It works like the standard MongoDB PHP extension interface but returns objects instead of arrays (as ODM). Queries stay the same.
One of its coolest features are joins which allow you to query for related objects.</p>

<p>List of features:</p>

<ul>
<li>
<a href="#stringid">String IDs</a> (easier linking in views)</li>
<li><a href="#embedded">Embedded objects</a></li>
<li>
<a href="#related">Related objects</a> (performing "join like" operations)</li>
<li><a href="#output">JSON format</a></li>
<li><a href="#pagination">Paginator</a></li>
<li>
<a href="#timestamps">Timestamps</a> (created_at and updated_at fields added on demand)</li>
<li><a href="#datetime">Printing date and time</a></li>
<li>
<a href="#transactions">Transactions</a> (PHP error support only)</li>
</ul><p><a name="requirements"></a></p>

<h2>
<a name="requirements" class="anchor" href="#requirements"><span class="octicon octicon-link"></span></a>Requirements</h2>

<ul>
<li>PHP 5.3+</li>
<li>PHP MongoDB Extension</li>
</ul><p><a name="installation"></a></p>

<h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>You can simply download it <a href="https://github.com/mawelous/yamop">here</a> or use <a href="http://getcomposer.org/">Composer</a>.</p>

<p>In the <code>require</code> key inside the <code>composer.json</code> file add the following</p>

<div class="highlight"><pre>    <span class="s">"mawelous/yamop"</span><span class="p-Indicator">:</span> <span class="s">"dev-master"</span>
</pre></div>

<p>Save it and run the Composer update command</p>

<pre><code>$ composer update
</code></pre>

<p>After Composer is done you only need to add the following lines to your code</p>

<div class="highlight"><pre>    <span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\MongoClient</span><span class="p">(</span> <span class="s1">'your_host'</span> <span class="p">);</span>
    <span class="nx">\Mawelous\Yamop\Mapper</span><span class="o">::</span><span class="na">setDatabase</span><span class="p">(</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">db_name</span> <span class="p">);</span>
</pre></div>

<p>You can pass any <code>MongoDB</code> instance to the <code>setDatabase</code> function.</p>

<p>Now extend <code>Mawelous\Yamop\Model</code> from within any of your models:</p>

<div class="highlight"><pre>    <span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">\Mawelous\Yamop\Model</span>
    <span class="p">{</span>
        <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_collectionName</span> <span class="o">=</span> <span class="s1">'users'</span><span class="p">;</span>    
    <span class="p">}</span>
</pre></div>

<p>That's it!</p>

<p><a name="usage"></a></p>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>Each object has an <code>_id</code>, which is a <code>MongoId</code>, and an <code>id</code> key which is its string representation.</p>

<p>Every document in <code>MongoDB</code> is returned as an object, every key is a property - here a sample document inside <code>MongoDB</code></p>

<div class="highlight"><pre>     <span class="p">{</span>
       <span class="nt">"_id"</span><span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">"51b6ea4fb7846c9410000001"</span><span class="err">)</span><span class="p">,</span>
       <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"John Doe"</span><span class="p">,</span>
       <span class="nt">"birthdate"</span><span class="p">:</span> <span class="err">ISODate(</span><span class="s2">"2013-05-25T12:15:25.0Z"</span><span class="err">)</span><span class="p">,</span>
       <span class="nt">"email"</span><span class="p">:</span> <span class="s2">"john@something.com"</span>
    <span class="p">}</span>    
</pre></div>

<p>The document above would be represented in PHP as follows:</p>

<div class="highlight"><pre>    <span class="nx">object</span><span class="p">(</span><span class="nx">User</span><span class="p">)[</span><span class="mi">44</span><span class="p">]</span>
      <span class="k">public</span> <span class="s1">'_id'</span> <span class="o">=&gt;</span> 
        <span class="nx">object</span><span class="p">(</span><span class="nx">MongoId</span><span class="p">)[</span><span class="mi">46</span><span class="p">]</span>
          <span class="k">public</span> <span class="s1">'$id'</span> <span class="o">=&gt;</span> <span class="nx">string</span> <span class="s1">'51b6ea4fb7846c9410000001'</span> <span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
      <span class="k">public</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nx">string</span> <span class="s1">'John Doe'</span> <span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
      <span class="k">public</span> <span class="s1">'birthdate'</span> <span class="o">=&gt;</span> 
        <span class="nx">object</span><span class="p">(</span><span class="nx">MongoDate</span><span class="p">)[</span><span class="mi">47</span><span class="p">]</span>
          <span class="k">public</span> <span class="s1">'sec'</span> <span class="o">=&gt;</span> <span class="nx">int</span> <span class="mi">1369484125</span>
          <span class="k">public</span> <span class="s1">'usec'</span> <span class="o">=&gt;</span> <span class="nx">int</span> <span class="mi">0</span>
      <span class="k">public</span> <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nx">string</span> <span class="s1">'john@something.com'</span> <span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
      <span class="k">public</span> <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">string</span> <span class="s1">'51b6ea4fb7846c9410000001'</span> <span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>

<p><a name="getting"></a></p>

<h3>
<a name="getting-data" class="anchor" href="#getting-data"><span class="octicon octicon-link"></span></a>Getting data</h3>

<p>Want to get a document by its id? There is a simple way.</p>

<p><a name="stringid"></a></p>

<div class="highlight"><pre>    <span class="nv">$stringId</span> <span class="o">=</span> <span class="p">;</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">findById</span><span class="p">(</span> <span class="s1">'51a61930b7846c400f000002'</span> <span class="p">)</span>
    <span class="c1">//or</span>
    <span class="nv">$mongoId</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="s1">'51a61930b7846c400f000002'</span> <span class="p">);</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">findById</span><span class="p">(</span> <span class="nv">$mongoId</span> <span class="p">)</span>
</pre></div>

<h4>
<a name="introducing-mapper" class="anchor" href="#introducing-mapper"><span class="octicon octicon-link"></span></a>Introducing Mapper</h4>

<p>There is a <code>Mapper</code> class in Yamop which is responsible for retrieving data. I separated it from <code>Model</code> so it can stay as data container. If you want to create more complicated queries you want to use the mapper. You can get it by using the <code>getMapper</code> method or creating new instance of it passing model class as string.</p>

<div class="highlight"><pre>    <span class="c1">//first possibility</span>
    <span class="nv">$mapper</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">getMapper</span><span class="p">();</span>
    <span class="c1">//second possibility</span>
    <span class="nv">$mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mawelous\Yamop\Mapper</span><span class="p">(</span> <span class="s1">'User'</span> <span class="p">);</span>
</pre></div>

<h4>
<a name="find-methods" class="anchor" href="#find-methods"><span class="octicon octicon-link"></span></a>Find methods</h4>

<p><code>findOne</code> works exactly like native <a><code>findOne</code></a> but it returns an object. As second parameter you can pass an array of fields. This means the parameters and queries stay the same, which is pretty great!</p>

<p><code>find</code> also works like native <a><code>find</code></a> but it returns a <code>Mapper</code>. You can then perform other operations on it like <code>sort</code>, <code>limit</code>, <code>skip</code> which all work like native as well.
To get result as array of objects use <code>get</code> method.</p>

<div class="highlight"><pre>    <span class="nv">$messages</span> <span class="o">=</span> <span class="nx">Message</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'to_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$stringId</span> <span class="p">),</span> <span class="s1">'to_status'</span> <span class="o">=&gt;</span> <span class="nx">Message</span><span class="o">::</span><span class="na">STATUS_UNREAD</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">sort</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'created_at'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span> <span class="mi">10</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span> 
</pre></div>

<p><a name="save"></a></p>

<h3>
<a name="save-update-and-delete" class="anchor" href="#save-update-and-delete"><span class="octicon octicon-link"></span></a>Save, Update and Delete</h3>

<p><code>save</code> method is used to create and update objects. That's the code to create new object and write it to the database</p>

<div class="highlight"><pre>    <span class="c1">// properties as array</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'John'</span><span class="p">,</span> <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'email@email.com'</span> <span class="p">)</span> <span class="p">);</span>

    <span class="c1">// or each property separately</span>
    <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">'John'</span><span class="p">;</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">emial</span> <span class="o">=</span> <span class="s1">'email@email.com'</span><span class="p">;</span>

    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</pre></div>

<p>You can get <code>_id</code> of newly created object just after <code>save</code>.</p>

<p>Deleting is simple</p>

<div class="highlight"><pre>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">();</span>
</pre></div>

<p>Those methods return the same results as the native <code>remove</code> and <code>save</code> methods. If you want to update multiple documents use the native function like <a href="#multiple-update">here</a>.</p>

<h3>
<a name="extending-mapper" class="anchor" href="#extending-mapper"><span class="octicon octicon-link"></span></a>Extending Mapper</h3>

<p>You can extend <code>Mapper</code> if you want to add more methods. For example I created UserMapper with has a method that posts a message on an user's Facebook wall. Just let it know which model class to use.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">UserMapper</span> <span class="k">extends</span> <span class="nx">Mawelous\Yamop\Mapper</span>
<span class="p">{</span>   
    <span class="k">protected</span> <span class="nv">$_modelClassName</span> <span class="o">=</span> <span class="s1">'User'</span><span class="p">;</span>    

    <span class="k">public</span> <span class="k">function</span> <span class="nf">findActiveUsers</span><span class="p">(</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="nv">$sort</span> <span class="o">=</span> <span class="s1">'birthdate'</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//method code</span>
    <span class="p">}</span>    
<span class="p">}</span>    
</pre></div>

<p>If you want to register a different <code>Mapper</code> for a model just declare it in the model</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="o">...</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_mapperClassName</span> <span class="o">=</span> <span class="s1">'UserMapper'</span><span class="p">;</span>
    <span class="o">...</span>
</pre></div>

<p>Now you just execute the <code>Mapper</code></p>

<div class="highlight"><pre>    <span class="nv">$mapper</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">getMapper</span><span class="p">();</span>
</pre></div>

<p>This will return an instance of UserMapper. You can also just create a new mapper</p>

<div class="highlight"><pre>    <span class="nv">$userMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserMapper</span><span class="p">;</span> 
</pre></div>

<p><a name="multiple-update"></a></p>

<h3>
<a name="count-indexes-and-multi-update" class="anchor" href="#count-indexes-and-multi-update"><span class="octicon octicon-link"></span></a>Count, Indexes, and multi update</h3>

<p>All methods called on <code>Mapper</code> that are not present are passed to the original <a><code>MongoCollection</code></a>. So you can use <code>update</code>, <code>count</code>, and <code>ensureIndex</code> directly with the native methods.</p>

<div class="highlight"><pre>    <span class="c1">//count</span>
    <span class="nx">Message</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'to_id'</span> <span class="o">=&gt;</span> <span class="nv">$userId</span><span class="p">,</span> <span class="s1">'to_status'</span> <span class="o">=&gt;</span> <span class="nx">Message</span><span class="o">::</span><span class="na">STATUS_UNREAD</span> <span class="p">)</span> <span class="p">);</span>
    <span class="c1">//update</span>
    <span class="nx">Contest</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nx">Contest</span><span class="o">::</span><span class="na">STATUS_READY_DRAFT</span><span class="p">,</span>
                  <span class="s1">'start_date'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'$lte'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoDate</span><span class="p">(</span><span class="nb">strtotime</span><span class="p">(</span><span class="s1">'midnight'</span><span class="p">))</span> <span class="p">)),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="nx">Contest</span><span class="o">::</span><span class="na">STATUS_ACTIVE</span><span class="p">)</span> <span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'multiple'</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)</span>
        <span class="p">);</span>
</pre></div>

<p><a name="embedded"></a></p>

<h3>
<a name="embedded-objects" class="anchor" href="#embedded-objects"><span class="octicon octicon-link"></span></a>Embedded objects</h3>

<p>Do you have more objects within the current object? Yamop will convert it automatically. Just let it know.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_collectionName</span> <span class="o">=</span> <span class="s1">'users'</span><span class="p">;</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_mapperClassName</span> <span class="o">=</span> <span class="s1">'UserMapper'</span><span class="p">;</span>  
    <span class="c1">// One Address object embedded in address property</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_embeddedObject</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
            <span class="s1">'address'</span> <span class="o">=&gt;</span> <span class="s1">'Address'</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="c1">// Many Notification objects embedded in array that is kept ass notifications</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_embeddedObjectList</span> <span class="o">=</span> <span class="k">array</span> <span class="p">(</span>
        <span class="s1">'notifications'</span> <span class="o">=&gt;</span> <span class="s1">'Notification'</span><span class="p">,</span>
    <span class="p">);</span>
</pre></div>

<p><a name="related"></a></p>

<h3>
<a name="related-objects" class="anchor" href="#related-objects"><span class="octicon octicon-link"></span></a>Related objects</h3>

<p>If there are relations between objects (there are sometimes) and you would like to "join" them, it's simpler than you would expect, even with <code>MongoDB</code>.</p>

<p>You don't have to register it anywhere. In my opinion it's better to do this explicit and avoid queries in background. </p>

<p>Here's the magic:</p>

<h4>
<a name="one" class="anchor" href="#one"><span class="octicon octicon-link"></span></a>One</h4>

<p>The <code>joinOne</code> method in every <code>Model</code> takes three parameters. First is the name of the property which keeps the <code>MongoId</code> of the related object, second is the related objects class, and third is the property name it will be joined at.</p>

<div class="highlight"><pre>    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">findById</span><span class="p">(</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$stringId</span> <span class="p">)</span> <span class="p">)</span><span class="o">-&gt;</span><span class="na">joinOne</span><span class="p">(</span> <span class="s1">'contest_id'</span><span class="p">,</span> <span class="s1">'Contest'</span><span class="p">,</span> <span class="s1">'contest'</span><span class="p">)</span>
    <span class="c1">// and there it is</span>
    <span class="nv">$contest</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">contest</span><span class="p">;</span>
</pre></div>

<h4>
<a name="many" class="anchor" href="#many"><span class="octicon octicon-link"></span></a>Many</h4>

<p>The <code>joinMany</code> method in every <code>Model</code> has also three parameters. First is the name of the property which keeps an array of <code>MongoId</code>'s, second is the related objects class, and third is the property name it will be joined at.</p>

<div class="highlight"><pre>    <span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">findById</span><span class="p">(</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$stringId</span> <span class="p">)</span> <span class="p">)</span><span class="o">-&gt;</span><span class="na">joinMany</span><span class="p">(</span> <span class="s1">'contests'</span><span class="p">,</span> <span class="s1">'Contest'</span><span class="p">,</span> <span class="s1">'contests'</span><span class="p">)</span>
    <span class="c1">// and you have array of contests there</span>
    <span class="nv">$contests</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">contests</span><span class="p">;</span>
</pre></div>

<p>If you want to join items to a list of items use <code>join</code> in a <code>Mapper</code>. Three parameters as in <code>joinOne</code>.</p>

<div class="highlight"><pre>    <span class="nv">$commentsList</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'contest_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$contestId</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">join</span><span class="p">(</span> <span class="s1">'user_id'</span><span class="p">,</span> <span class="s1">'User'</span><span class="p">,</span> <span class="s1">'author'</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">limit</span><span class="p">(</span> <span class="mi">10</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</pre></div>

<p><a name="output"></a></p>

<h3>
<a name="output-format" class="anchor" href="#output-format"><span class="octicon octicon-link"></span></a>Output format</h3>

<p>Default fetching mode converts arrays to objects but you can also get array or JSON with <code>getArray</code> and <code>getJson</code>.</p>

<div class="highlight"><pre>    <span class="c1">//first possibility</span>
    <span class="nx">Comment</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'contest_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$contestId</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">getArray</span><span class="p">();</span>

    <span class="nx">Comment</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'contest_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$contestId</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">getJson</span><span class="p">();</span>

    <span class="cm">/* second possibility</span>
<span class="cm">        three fetch types as constants in Mapper</span>
<span class="cm">        FETCH_OBJECT</span>
<span class="cm">        FETCH_ARRAY </span>
<span class="cm">        FETCH_JSON  </span>
<span class="cm">    */</span>
    <span class="nx">Comment</span><span class="o">::</span><span class="na">getMapper</span><span class="p">(</span> <span class="nx">\Mawelous\Yamop\Mapper</span><span class="o">::</span><span class="na">FETCH_JSON</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'contest_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$contestId</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

    <span class="cm">/* third possibility */</span>
    <span class="nx">Comment</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">setFetchType</span><span class="p">(</span><span class="nx">\Mawelous\Yamop\Mapper</span><span class="o">::</span><span class="na">FETCH_JSON</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="s1">'contest_id'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">MongoId</span><span class="p">(</span> <span class="nv">$contestId</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>        
</pre></div>

<p><a name="pagination"></a></p>

<h3>
<a name="pagination" class="anchor" href="#pagination"><span class="octicon octicon-link"></span></a>Pagination</h3>

<p>Yamop supports pagination with a little help from you. It has a <code>getPaginator</code> method which takes two parameters. First is the current page number, second is the amount of items per page.</p>

<div class="highlight"><pre>    <span class="nx">User</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span> <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'$ne'</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="o">::</span><span class="na">STATUS_DELETED</span> <span class="p">))</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">sort</span><span class="p">(</span> <span class="k">array</span><span class="p">(</span> <span class="nv">$field</span> <span class="o">=&gt;</span> <span class="nv">$direction</span> <span class="p">)</span> <span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">getPaginator</span><span class="p">(</span> <span class="nv">$page</span><span class="p">,</span> <span class="nv">$perPage</span> <span class="p">);</span>
</pre></div>

<p>Your framework probably has its own paginator. Before you use the <code>getPaginator</code> method you have to implement the <code>_createPaginator</code> method in a mapper that extends <code>Mawelous\Yamop\Mapper</code>.</p>

<p><a href="http://laravel.com">Laravel 3</a> would be extended like this:</p>

<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">class</span> <span class="nc">Mapper</span> <span class="k">extends</span> <span class="nx">\Mawelous\Yamop\Mapper</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_createPaginator</span><span class="p">(</span><span class="nv">$results</span><span class="p">,</span> <span class="nv">$totalCount</span><span class="p">,</span> <span class="nv">$perPage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">\Paginator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span> <span class="nv">$results</span><span class="p">,</span> <span class="nv">$totalCount</span><span class="p">,</span> <span class="nv">$perPage</span> <span class="p">);</span> 
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><a name="timestamps"></a></p>

<h3>
<a name="timestamps" class="anchor" href="#timestamps"><span class="octicon octicon-link"></span></a>Timestamps</h3>

<p>It's common to have a <code>created_at</code> and <code>updated_at</code> key in our objects. If you want to have them be set automatically for your <code>Model</code>, just declare it:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="o">...</span>
    <span class="k">public</span> <span class="k">static</span> <span class="nv">$timestamps</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>   
    <span class="o">....</span>
</pre></div>

<p><a name="datetime"></a></p>

<h3>
<a name="printing-date-and-time" class="anchor" href="#printing-date-and-time"><span class="octicon octicon-link"></span></a>Printing date and time</h3>

<p>Whether you have a timestamp or not, you might still like to print the date or time. It's recommend to keep dates as <code>MongoDate</code> this way you can echo it with <code>getTime</code> or <code>getDate</code> which takes two parameters. First is the <code>MongoDate</code> property name, second is a string that represents format passed to the PHP <code>date</code> function:</p>

<div class="highlight"><pre>    <span class="c1">//date as string</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getDate</span><span class="p">(</span> <span class="s1">'birthdate'</span><span class="p">,</span> <span class="s1">'Y/m/d'</span> <span class="p">);</span>
    <span class="c1">//time as string</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getTime</span><span class="p">(</span> <span class="s1">'created_at'</span><span class="p">,</span> <span class="s1">'Y/m/d H:i'</span><span class="p">);</span>
    <span class="c1">//time as string using default format set in $dateFormat</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getTime</span><span class="p">(</span> <span class="s1">'created_at'</span> <span class="p">);</span>    
</pre></div>

<p><code>Mawelous\Yamop\Model</code> has its default date format defined in the public static <code>$dateFormat</code> property and a time format in <code>$timeFormat</code>. You can override it if you like.</p>

<p><a name="transactions"></a></p>

<h3>
<a name="transactions" class="anchor" href="#transactions"><span class="octicon octicon-link"></span></a>Transactions</h3>

<p><strong>EXPERIMENTAL!</strong> - It's an addition to Yamop which works independently. It doesn't support a <a>two phase commit</a> but at least it can revert changes.</p>

<p>That's what <code>Mawelous\Yamop\Transaction</code> is for. First you have to handle errors and run the <code>rollback</code> method within it. </p>

<p>Similar to this:</p>

<div class="highlight"><pre>    <span class="nb">set_error_handler</span><span class="p">(</span> <span class="k">function</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span> <span class="nv">$error</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Transaction</span><span class="o">::</span><span class="na">rollback</span><span class="p">();</span>
        <span class="k">require_once</span> <span class="nx">path</span><span class="p">(</span><span class="s1">'sys'</span><span class="p">)</span><span class="o">.</span><span class="s1">'error'</span><span class="o">.</span><span class="nx">EXT</span><span class="p">;</span>
        <span class="nx">Laravel\Error</span><span class="o">::</span><span class="na">native</span><span class="p">(</span><span class="nv">$code</span><span class="p">,</span> <span class="nv">$error</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>

<p>Then you can start using the <code>add</code> method. With <code>add</code> you add code to revert changes you made with save or update. You can use a closure to do that. </p>

<p>Here an example:</p>

<div class="highlight"><pre>    <span class="nx">User</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'$in'</span> <span class="o">=&gt;</span> <span class="nv">$userIds</span> <span class="p">)),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">'$inc'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'active_contests'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)),</span>
        <span class="k">array</span><span class="p">(</span><span class="s1">'multiple'</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="nx">Transaction</span><span class="o">::</span><span class="na">add</span><span class="p">(</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span> <span class="nv">$userIds</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">User</span><span class="o">::</span><span class="na">getMapper</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span> <span class="s1">'$in'</span> <span class="o">=&gt;</span> <span class="nv">$userIds</span> <span class="p">)),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'$inc'</span> <span class="o">=&gt;</span> <span class="k">array</span> <span class="p">(</span><span class="s1">'active_contests'</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">)),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'multiple'</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">);</span>
    <span class="p">});</span>
</pre></div>

<p>Now when error happens <code>rollback</code> will invoke all added methods.</p>

<p><a name="issues"></a></p>

<h2>
<a name="issues" class="anchor" href="#issues"><span class="octicon octicon-link"></span></a>Issues</h2>

<p>Any issues or questions please <a href="https://github.com/Mawelous/yamop/issues">report here</a></p>

<p><a name="license"></a></p>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Yamop is free software distributed under the terms of the <a href="http://opensource.org/licenses/MIT">MIT license</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Yamop maintained by <a href="https://github.com/mawelous">mawelous</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
